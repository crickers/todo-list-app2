import"/node_modules/core-js/modules/es.array.iterator.js";import"/node_modules/core-js/modules/es.array.slice.js";import"/node_modules/core-js/modules/es.promise.js";import"/node_modules/core-js/modules/es.regexp.to-string.js";import"/node_modules/core-js/modules/web.dom-collections.iterator.js";import _extends from"/node_modules/@babel/runtime/helpers/esm/extends.js";import _defineProperty from"/node_modules/@babel/runtime/helpers/esm/defineProperty.js";import _objectWithoutProperties from"/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js";import _slicedToArray from"/node_modules/@babel/runtime/helpers/esm/slicedToArray.js";import _classCallCheck from"/node_modules/@babel/runtime/helpers/esm/classCallCheck.js";import _createClass from"/node_modules/@babel/runtime/helpers/esm/createClass.js";import _inherits from"/node_modules/@babel/runtime/helpers/esm/inherits.js";import _createSuper from"/node_modules/@babel/runtime/helpers/esm/createSuper.js";import React,{Component}from"c:\\node_modules\\react\\index.js";import classNames from"/node_modules/classnames.js";import pickAttrs from"/node_modules/rc-util/es/pickAttrs.js";import defaultRequest from"/node_modules/rc-upload/es/request.js";import getUid from"/node_modules/rc-upload/es/uid.js";import attrAccept from"/node_modules/rc-upload/es/attr-accept.js";import traverseFileTree from"/node_modules/rc-upload/es/traverseFileTree.js";var AjaxUploader=function(_Component){function AjaxUploader(){var _this;return _classCallCheck(this,AjaxUploader),_this=_super.apply(this,arguments),_this.state={uid:getUid()},_this.reqs={},_this.onChange=function(e){var files=e.target.files;_this.uploadFiles(files),_this.reset()},_this.onClick=function(e){var el=_this.fileInput;if(el){var _this$props=_this.props,children=_this$props.children,onClick=_this$props.onClick;if(children&&"button"===children.type){var parent=el.parentNode;parent.focus(),parent.querySelector("button").blur()}el.click(),onClick&&onClick(e)}},_this.onKeyDown=function(e){"Enter"===e.key&&_this.onClick(e)},_this.onFileDrop=function(e){var multiple=_this.props.multiple;if(e.preventDefault(),"dragover"!==e.type)if(_this.props.directory)traverseFileTree(Array.prototype.slice.call(e.dataTransfer.items),_this.uploadFiles,function(_file){return attrAccept(_file,_this.props.accept)});else{var files=Array.prototype.slice.call(e.dataTransfer.files).filter(function(file){return attrAccept(file,_this.props.accept)});!1===multiple&&(files=files.slice(0,1)),_this.uploadFiles(files)}},_this.uploadFiles=function(files){var postFiles=Array.prototype.slice.call(files);postFiles.map(function(file){return file.uid=getUid(),file}).forEach(function(file){_this.upload(file,postFiles)})},_this.saveFileInput=function(node){_this.fileInput=node},_this}_inherits(AjaxUploader,_Component);var _super=_createSuper(AjaxUploader);return _createClass(AjaxUploader,[{key:"componentDidMount",value:function componentDidMount(){this._isMounted=!0}},{key:"componentWillUnmount",value:function componentWillUnmount(){this._isMounted=!1,this.abort()}},{key:"upload",value:function upload(file,fileList){var _this2=this,props=this.props;if(!props.beforeUpload)return void Promise.resolve().then(function(){_this2.post(file)});var before=props.beforeUpload(file,fileList);before&&"boolean"!=typeof before&&before.then?before.then(function(processedFile){var processedFileType=Object.prototype.toString.call(processedFile);return"[object File]"===processedFileType||"[object Blob]"===processedFileType?void _this2.post(processedFile):void _this2.post(file)}).catch(function(e){console.log(e)}):!1!==before&&Promise.resolve().then(function(){_this2.post(file)})}},{key:"post",value:function post(file){var _this3=this;if(this._isMounted){var props=this.props,onStart=props.onStart,onProgress=props.onProgress,_props$transformFile=props.transformFile,transformFile=void 0===_props$transformFile?function(originFile){return originFile}:_props$transformFile;new Promise(function(resolve){var actionRet=props.action;return"function"==typeof actionRet&&(actionRet=actionRet(file)),resolve(actionRet)}).then(function(action){var uid=file.uid,request=props.customRequest||defaultRequest,transform=Promise.resolve(transformFile(file)).then(function(transformedFile){var data=props.data;return"function"==typeof data&&(data=data(transformedFile)),Promise.all([transformedFile,data])}).catch(function(e){console.error(e)});transform.then(function(_ref){var _ref2=_slicedToArray(_ref,2),transformedFile=_ref2[0],data=_ref2[1],requestOption={action:action,filename:props.name,data:data,file:transformedFile,headers:props.headers,withCredentials:props.withCredentials,method:props.method||"post",onProgress:onProgress?function(e){onProgress(e,file)}:null,onSuccess:function onSuccess(ret,xhr){delete _this3.reqs[uid],props.onSuccess(ret,file,xhr)},onError:function onError(err,ret){delete _this3.reqs[uid],props.onError(err,ret,file)}};onStart(file),_this3.reqs[uid]=request(requestOption)})})}}},{key:"reset",value:function reset(){this.setState({uid:getUid()})}},{key:"abort",value:function abort(file){var reqs=this.reqs;if(file){var uid=file.uid?file.uid:file;reqs[uid]&&reqs[uid].abort&&reqs[uid].abort(),delete reqs[uid]}else Object.keys(reqs).forEach(function(uid){reqs[uid]&&reqs[uid].abort&&reqs[uid].abort(),delete reqs[uid]})}},{key:"render",value:function render(){var _classNames,_this$props2=this.props,Tag=_this$props2.component,prefixCls=_this$props2.prefixCls,className=_this$props2.className,disabled=_this$props2.disabled,id=_this$props2.id,style=_this$props2.style,multiple=_this$props2.multiple,accept=_this$props2.accept,children=_this$props2.children,directory=_this$props2.directory,openFileDialogOnClick=_this$props2.openFileDialogOnClick,onMouseEnter=_this$props2.onMouseEnter,onMouseLeave=_this$props2.onMouseLeave,otherProps=_objectWithoutProperties(_this$props2,["component","prefixCls","className","disabled","id","style","multiple","accept","children","directory","openFileDialogOnClick","onMouseEnter","onMouseLeave"]),cls=classNames((_classNames={},_defineProperty(_classNames,prefixCls,!0),_defineProperty(_classNames,"".concat(prefixCls,"-disabled"),disabled),_defineProperty(_classNames,className,className),_classNames)),dirProps=directory?{directory:"directory",webkitdirectory:"webkitdirectory"}:{},events=disabled?{}:{onClick:openFileDialogOnClick?this.onClick:function(){},onKeyDown:openFileDialogOnClick?this.onKeyDown:function(){},onMouseEnter:onMouseEnter,onMouseLeave:onMouseLeave,onDrop:this.onFileDrop,onDragOver:this.onFileDrop,tabIndex:"0"};return React.createElement(Tag,_extends({},events,{className:cls,role:"button",style:style}),React.createElement("input",_extends({},pickAttrs(otherProps,{aria:!0,data:!0}),{id:id,type:"file",ref:this.saveFileInput,onClick:function onClick(e){return e.stopPropagation()},key:this.state.uid,style:{display:"none"},accept:accept},dirProps,{multiple:multiple,onChange:this.onChange})),children)}}]),AjaxUploader}(Component);export default AjaxUploader;