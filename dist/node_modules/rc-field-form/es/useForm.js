import"/node_modules/core-js/modules/es.array.iterator.js";import"/node_modules/core-js/modules/es.promise.js";import"/node_modules/core-js/modules/esnext.set.add-all.js";import"/node_modules/core-js/modules/esnext.set.delete-all.js";import"/node_modules/core-js/modules/esnext.set.difference.js";import"/node_modules/core-js/modules/esnext.set.every.js";import"/node_modules/core-js/modules/esnext.set.filter.js";import"/node_modules/core-js/modules/esnext.set.find.js";import"/node_modules/core-js/modules/esnext.set.intersection.js";import"/node_modules/core-js/modules/esnext.set.is-disjoint-from.js";import"/node_modules/core-js/modules/esnext.set.is-subset-of.js";import"/node_modules/core-js/modules/esnext.set.is-superset-of.js";import"/node_modules/core-js/modules/esnext.set.join.js";import"/node_modules/core-js/modules/esnext.set.map.js";import"/node_modules/core-js/modules/esnext.set.reduce.js";import"/node_modules/core-js/modules/esnext.set.some.js";import"/node_modules/core-js/modules/esnext.set.symmetric-difference.js";import"/node_modules/core-js/modules/esnext.set.union.js";import"/node_modules/core-js/modules/web.dom-collections.iterator.js";import _slicedToArray from"/node_modules/@babel/runtime/helpers/esm/slicedToArray.js";import _objectSpread from"/node_modules/@babel/runtime/helpers/esm/objectSpread2.js";import _objectWithoutProperties from"/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js";import _toConsumableArray from"/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js";import _classCallCheck from"/node_modules/@babel/runtime/helpers/esm/classCallCheck.js";import React from"c:\\node_modules\\react\\index.js";import warning from"/node_modules/rc-util/es/warning.js";import{HOOK_MARK}from"/node_modules/rc-field-form/es/FieldContext.js";import{allPromiseFinish}from"/node_modules/rc-field-form/es/utils/asyncUtil.js";import NameMap from"/node_modules/rc-field-form/es/utils/NameMap.js";import{defaultValidateMessages}from"/node_modules/rc-field-form/es/utils/messages.js";import{cloneByNamePathList,containsNamePath,getNamePath,getValue,matchNamePath,setValue,setValues}from"/node_modules/rc-field-form/es/utils/valueUtil.js";export var FormStore=function FormStore(forceRootUpdate){var _this=this;_classCallCheck(this,FormStore),this.formHooked=!1,this.subscribable=!0,this.store={},this.fieldEntities=[],this.initialValues={},this.callbacks={},this.validateMessages=null,this.preserve=null,this.lastValidatePromise=null,this.getForm=function(){return{getFieldValue:_this.getFieldValue,getFieldsValue:_this.getFieldsValue,getFieldError:_this.getFieldError,getFieldsError:_this.getFieldsError,isFieldsTouched:_this.isFieldsTouched,isFieldTouched:_this.isFieldTouched,isFieldValidating:_this.isFieldValidating,isFieldsValidating:_this.isFieldsValidating,resetFields:_this.resetFields,setFields:_this.setFields,setFieldsValue:_this.setFieldsValue,validateFields:_this.validateFields,submit:_this.submit,getInternalHooks:_this.getInternalHooks}},this.getInternalHooks=function(key){return key===HOOK_MARK?(_this.formHooked=!0,{dispatch:_this.dispatch,initEntityValue:_this.initEntityValue,registerField:_this.registerField,useSubscribe:_this.useSubscribe,setInitialValues:_this.setInitialValues,setCallbacks:_this.setCallbacks,setValidateMessages:_this.setValidateMessages,getFields:_this.getFields,setPreserve:_this.setPreserve}):(warning(!1,"`getInternalHooks` is internal usage. Should not call directly."),null)},this.useSubscribe=function(subscribable){_this.subscribable=subscribable},this.setInitialValues=function(initialValues,init){_this.initialValues=initialValues||{},init&&(_this.store=setValues({},initialValues,_this.store))},this.getInitialValue=function(namePath){return getValue(_this.initialValues,namePath)},this.setCallbacks=function(callbacks){_this.callbacks=callbacks},this.setValidateMessages=function(validateMessages){_this.validateMessages=validateMessages},this.setPreserve=function(preserve){_this.preserve=preserve},this.timeoutId=null,this.warningUnhooked=function(){},this.getFieldEntities=function(){var pure=!!(0<arguments.length&&arguments[0]!==void 0)&&arguments[0];return pure?_this.fieldEntities.filter(function(field){return field.getNamePath().length}):_this.fieldEntities},this.getFieldsMap=function(){var pure=!!(0<arguments.length&&void 0!==arguments[0])&&arguments[0],cache=new NameMap;return _this.getFieldEntities(pure).forEach(function(field){var namePath=field.getNamePath();cache.set(namePath,field)}),cache},this.getFieldEntitiesForNamePathList=function(nameList){if(!nameList)return _this.getFieldEntities(!0);var cache=_this.getFieldsMap(!0);return nameList.map(function(name){var namePath=getNamePath(name);return cache.get(namePath)||{INVALIDATE_NAME_PATH:getNamePath(name)}})},this.getFieldsValue=function(nameList,filterFunc){if(_this.warningUnhooked(),!0===nameList&&!filterFunc)return _this.store;var fieldEntities=_this.getFieldEntitiesForNamePathList(Array.isArray(nameList)?nameList:null),filteredNameList=[];return fieldEntities.forEach(function(entity){var _entity$isListField,namePath="INVALIDATE_NAME_PATH"in entity?entity.INVALIDATE_NAME_PATH:entity.getNamePath();if(nameList||null===(_entity$isListField=entity.isListField)||void 0===_entity$isListField||!_entity$isListField.call(entity))if(!filterFunc)filteredNameList.push(namePath);else{var meta="getMeta"in entity?entity.getMeta():null;filterFunc(meta)&&filteredNameList.push(namePath)}}),cloneByNamePathList(_this.store,filteredNameList.map(getNamePath))},this.getFieldValue=function(name){_this.warningUnhooked();var namePath=getNamePath(name);return getValue(_this.store,namePath)},this.getFieldsError=function(nameList){_this.warningUnhooked();var fieldEntities=_this.getFieldEntitiesForNamePathList(nameList);return fieldEntities.map(function(entity,index){return entity&&!("INVALIDATE_NAME_PATH"in entity)?{name:entity.getNamePath(),errors:entity.getErrors()}:{name:getNamePath(nameList[index]),errors:[]}})},this.getFieldError=function(name){_this.warningUnhooked();var namePath=getNamePath(name),fieldError=_this.getFieldsError([namePath])[0];return fieldError.errors},this.isFieldsTouched=function(){_this.warningUnhooked();for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];var namePathList,arg0=args[0],arg1=args[1],isAllFieldsTouched=!1;0===args.length?namePathList=null:1===args.length?Array.isArray(arg0)?(namePathList=arg0.map(getNamePath),isAllFieldsTouched=!1):(namePathList=null,isAllFieldsTouched=arg0):(namePathList=arg0.map(getNamePath),isAllFieldsTouched=arg1);var fieldEntities=_this.getFieldEntities(!0),isFieldTouched=function isFieldTouched(field){return field.isFieldTouched()};if(!namePathList)return isAllFieldsTouched?fieldEntities.every(isFieldTouched):fieldEntities.some(isFieldTouched);var map=new NameMap;namePathList.forEach(function(shortNamePath){map.set(shortNamePath,[])}),fieldEntities.forEach(function(field){var fieldNamePath=field.getNamePath();namePathList.forEach(function(shortNamePath){shortNamePath.every(function(nameUnit,i){return fieldNamePath[i]===nameUnit})&&map.update(shortNamePath,function(list){return[].concat(_toConsumableArray(list),[field])})})});var isNamePathListTouched=function isNamePathListTouched(entities){return entities.some(isFieldTouched)},namePathListEntities=map.map(function(_ref){var value=_ref.value;return value});return isAllFieldsTouched?namePathListEntities.every(isNamePathListTouched):namePathListEntities.some(isNamePathListTouched)},this.isFieldTouched=function(name){return _this.warningUnhooked(),_this.isFieldsTouched([name])},this.isFieldsValidating=function(nameList){_this.warningUnhooked();var fieldEntities=_this.getFieldEntities();if(!nameList)return fieldEntities.some(function(testField){return testField.isFieldValidating()});var namePathList=nameList.map(getNamePath);return fieldEntities.some(function(testField){var fieldNamePath=testField.getNamePath();return containsNamePath(namePathList,fieldNamePath)&&testField.isFieldValidating()})},this.isFieldValidating=function(name){return _this.warningUnhooked(),_this.isFieldsValidating([name])},this.resetWithFieldInitialValue=function(){var info=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},cache=new NameMap,fieldEntities=_this.getFieldEntities(!0);fieldEntities.forEach(function(field){var initialValue=field.props.initialValue,namePath=field.getNamePath();if(initialValue!==void 0){var records=cache.get(namePath)||new Set;records.add({entity:field,value:initialValue}),cache.set(namePath,records)}});var requiredFieldEntities;info.entities?requiredFieldEntities=info.entities:info.namePathList?(requiredFieldEntities=[],info.namePathList.forEach(function(namePath){var records=cache.get(namePath);if(records){var _requiredFieldEntitie;(_requiredFieldEntitie=requiredFieldEntities).push.apply(_requiredFieldEntitie,_toConsumableArray(_toConsumableArray(records).map(function(r){return r.entity})))}})):requiredFieldEntities=fieldEntities,function resetWithFields(entities){entities.forEach(function(field){var initialValue=field.props.initialValue;if(initialValue!==void 0){var namePath=field.getNamePath(),formInitialValue=_this.getInitialValue(namePath);if(formInitialValue!==void 0)warning(!1,"Form already set 'initialValues' with path '".concat(namePath.join("."),"'. Field can not overwrite it."));else{var records=cache.get(namePath);if(records&&1<records.size)warning(!1,"Multiple Field with path '".concat(namePath.join("."),"' set 'initialValue'. Can not decide which one to pick."));else if(records){var originValue=_this.getFieldValue(namePath);info.skipExist&&originValue!==void 0||(_this.store=setValue(_this.store,namePath,_toConsumableArray(records)[0].value))}}}})}(requiredFieldEntities)},this.resetFields=function(nameList){_this.warningUnhooked();var prevStore=_this.store;if(!nameList)return _this.store=setValues({},_this.initialValues),_this.resetWithFieldInitialValue(),void _this.notifyObservers(prevStore,null,{type:"reset"});var namePathList=nameList.map(getNamePath);namePathList.forEach(function(namePath){var initialValue=_this.getInitialValue(namePath);_this.store=setValue(_this.store,namePath,initialValue)}),_this.resetWithFieldInitialValue({namePathList:namePathList}),_this.notifyObservers(prevStore,namePathList,{type:"reset"})},this.setFields=function(fields){_this.warningUnhooked();var prevStore=_this.store;fields.forEach(function(fieldData){var name=fieldData.name,errors=fieldData.errors,data=_objectWithoutProperties(fieldData,["name","errors"]),namePath=getNamePath(name);"value"in data&&(_this.store=setValue(_this.store,namePath,data.value)),_this.notifyObservers(prevStore,[namePath],{type:"setField",data:fieldData})})},this.getFields=function(){var entities=_this.getFieldEntities(!0),fields=entities.map(function(field){var namePath=field.getNamePath(),meta=field.getMeta(),fieldData=_objectSpread(_objectSpread({},meta),{},{name:namePath,value:_this.getFieldValue(namePath)});return Object.defineProperty(fieldData,"originRCField",{value:!0}),fieldData});return fields},this.initEntityValue=function(entity){var initialValue=entity.props.initialValue;if(initialValue!==void 0){var namePath=entity.getNamePath(),prevValue=getValue(_this.store,namePath);prevValue===void 0&&(_this.store=setValue(_this.store,namePath,initialValue))}},this.registerField=function(entity){if(_this.fieldEntities.push(entity),void 0!==entity.props.initialValue){var prevStore=_this.store;_this.resetWithFieldInitialValue({entities:[entity],skipExist:!0}),_this.notifyObservers(prevStore,[entity.getNamePath()],{type:"valueUpdate",source:"internal"})}return function(isListField,preserve){_this.fieldEntities=_this.fieldEntities.filter(function(item){return item!==entity});var mergedPreserve=void 0===preserve?_this.preserve:preserve;if(!1===mergedPreserve&&!isListField){var namePath=entity.getNamePath(),defaultValue=getValue(_this.initialValues,namePath);namePath.length&&_this.getFieldValue(namePath)!==defaultValue&&_this.fieldEntities.every(function(field){return!matchNamePath(field.getNamePath(),namePath)})&&(_this.store=setValue(_this.store,namePath,defaultValue))}}},this.dispatch=function(action){switch(action.type){case"updateValue":{var namePath=action.namePath,value=action.value;_this.updateValue(namePath,value);break}case"validateField":{var _namePath=action.namePath,triggerName=action.triggerName;_this.validateFields([_namePath],{triggerName:triggerName});break}default:}},this.notifyObservers=function(prevStore,namePathList,info){if(_this.subscribable){var mergedInfo=_objectSpread(_objectSpread({},info),{},{store:_this.getFieldsValue(!0)});_this.getFieldEntities().forEach(function(_ref2){var onStoreChange=_ref2.onStoreChange;onStoreChange(prevStore,namePathList,mergedInfo)})}else _this.forceRootUpdate()},this.updateValue=function(name,value){var namePath=getNamePath(name),prevStore=_this.store;_this.store=setValue(_this.store,namePath,value),_this.notifyObservers(prevStore,[namePath],{type:"valueUpdate",source:"internal"});var childrenFields=_this.getDependencyChildrenFields(namePath);childrenFields.length&&_this.validateFields(childrenFields),_this.notifyObservers(prevStore,childrenFields,{type:"dependenciesUpdate",relatedFields:[namePath].concat(_toConsumableArray(childrenFields))});var onValuesChange=_this.callbacks.onValuesChange;if(onValuesChange){var changedValues=cloneByNamePathList(_this.store,[namePath]);onValuesChange(changedValues,_this.getFieldsValue())}_this.triggerOnFieldsChange([namePath].concat(_toConsumableArray(childrenFields)))},this.setFieldsValue=function(store){_this.warningUnhooked();var prevStore=_this.store;store&&(_this.store=setValues(_this.store,store)),_this.notifyObservers(prevStore,null,{type:"valueUpdate",source:"external"})},this.getDependencyChildrenFields=function(rootNamePath){var children=new Set,childrenFields=[],dependencies2fields=new NameMap;return _this.getFieldEntities().forEach(function(field){var dependencies=field.props.dependencies;(dependencies||[]).forEach(function(dependency){var dependencyNamePath=getNamePath(dependency);dependencies2fields.update(dependencyNamePath,function(){var fields=0<arguments.length&&void 0!==arguments[0]?arguments[0]:new Set;return fields.add(field),fields})})}),function fillChildren(namePath){var fields=dependencies2fields.get(namePath)||new Set;fields.forEach(function(field){if(!children.has(field)){children.add(field);var fieldNamePath=field.getNamePath();field.isFieldDirty()&&fieldNamePath.length&&(childrenFields.push(fieldNamePath),fillChildren(fieldNamePath))}})}(rootNamePath),childrenFields},this.triggerOnFieldsChange=function(namePathList,filedErrors){var onFieldsChange=_this.callbacks.onFieldsChange;if(onFieldsChange){var fields=_this.getFields();if(filedErrors){var cache=new NameMap;filedErrors.forEach(function(_ref3){var name=_ref3.name,errors=_ref3.errors;cache.set(name,errors)}),fields.forEach(function(field){field.errors=cache.get(field.name)||field.errors})}var changedFields=fields.filter(function(_ref4){var fieldName=_ref4.name;return containsNamePath(namePathList,fieldName)});onFieldsChange(changedFields,fields)}},this.validateFields=function(nameList,options){_this.warningUnhooked();var provideNameList=!!nameList,namePathList=provideNameList?nameList.map(getNamePath):[],promiseList=[];_this.getFieldEntities(!0).forEach(function(field){if(provideNameList||namePathList.push(field.getNamePath()),(null===options||void 0===options?void 0:options.recursive)&&provideNameList){var namePath=field.getNamePath();namePath.every(function(nameUnit,i){return nameList[i]===nameUnit||void 0===nameList[i]})&&namePathList.push(namePath)}if(field.props.rules&&field.props.rules.length){var fieldNamePath=field.getNamePath();if(!provideNameList||containsNamePath(namePathList,fieldNamePath)){var promise=field.validateRules(_objectSpread({validateMessages:_objectSpread(_objectSpread({},defaultValidateMessages),_this.validateMessages)},options));promiseList.push(promise.then(function(){return{name:fieldNamePath,errors:[]}}).catch(function(errors){return Promise.reject({name:fieldNamePath,errors:errors})}))}}});var summaryPromise=allPromiseFinish(promiseList);_this.lastValidatePromise=summaryPromise,summaryPromise.catch(function(results){return results}).then(function(results){var resultNamePathList=results.map(function(_ref5){var name=_ref5.name;return name});_this.notifyObservers(_this.store,resultNamePathList,{type:"validateFinish"}),_this.triggerOnFieldsChange(resultNamePathList,results)});var returnPromise=summaryPromise.then(function(){return _this.lastValidatePromise===summaryPromise?Promise.resolve(_this.getFieldsValue(namePathList)):Promise.reject([])}).catch(function(results){var errorList=results.filter(function(result){return result&&result.errors.length});return Promise.reject({values:_this.getFieldsValue(namePathList),errorFields:errorList,outOfDate:_this.lastValidatePromise!==summaryPromise})});return returnPromise.catch(function(e){return e}),returnPromise},this.submit=function(){_this.warningUnhooked(),_this.validateFields().then(function(values){var onFinish=_this.callbacks.onFinish;if(onFinish)try{onFinish(values)}catch(err){console.error(err)}}).catch(function(e){var onFinishFailed=_this.callbacks.onFinishFailed;onFinishFailed&&onFinishFailed(e)})},this.forceRootUpdate=forceRootUpdate};function useForm(form){var formRef=React.useRef(),_React$useState=React.useState({}),_React$useState2=_slicedToArray(_React$useState,2),forceUpdate=_React$useState2[1];if(!formRef.current)if(form)formRef.current=form;else{var forceReRender=function forceReRender(){forceUpdate({})},formStore=new FormStore(forceReRender);formRef.current=formStore.getForm()}return[formRef.current]}export default useForm;